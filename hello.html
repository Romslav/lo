<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–æ—è–ª—å–Ω–æ—Å—Ç—å –†–µ—Å—Ç–æ—Ä–∞–Ω–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container { max-width: 400px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .card { 
            background: white; border-radius: 20px; padding: 25px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1); margin-bottom: 20px;
        }
        .balance { font-size: 36px; font-weight: bold; color: #4CAF50; text-align: center; }
        .qr-code { 
            width: 200px; height: 200px; margin: 20px auto; 
            background: #f0f0f0; border-radius: 15px; display: flex; align-items: center; justify-content: center;
            font-size: 12px; color: #666;
        }
        .btn { 
            width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 12px; 
            font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s;
        }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-secondary { background: #2196F3; color: white; }
        .btn-success { background: #FF9800; color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .history { max-height: 200px; overflow-y: auto; }
        .history-item { padding: 10px; border-bottom: 1px solid #eee; font-size: 14px; }
        .level-bar { 
            height: 8px; background: #e0e0e0; border-radius: 4px; 
            margin: 10px 0; overflow: hidden;
        }
        .level-progress { height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A); transition: width 0.5s; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçΩÔ∏è –õ–æ—è–ª—å–Ω–æ—Å—Ç—å</h1>
            <div id="userName"></div>
        </div>

        <div class="card">
            <div class="balance" id="balance">0 –±–∞–ª–ª–æ–≤</div>
            <div class="level-bar">
                <div class="level-progress" id="levelProgress" style="width: 0%"></div>
            </div>
            <div style="text-align: center; color: #666; font-size: 14px;">
                –î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è: <span id="nextLevel">500</span> –±–∞–ª–ª–æ–≤
            </div>
        </div>

        <div class="card">
            <div class="qr-code" id="qrCode">–í–∞—à–∞ QR-–∫–∞—Ä—Ç–∞<br>–¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è</div>
            <button class="btn btn-primary" onclick="showCheckin()">üì∏ –ù–∞—á–∏—Å–ª–∏—Ç—å –±–æ–Ω—É—Å—ã</button>
            <button class="btn btn-secondary" onclick="spendBonus()">üí∞ –°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª—ã</button>
        </div>

        <div class="card">
            <h3>üéÅ –ê–∫—Ü–∏–∏</h3>
            <div class="history">
                <div class="history-item">–ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞: +100 –±–∞–ª–ª–æ–≤</div>
                <div class="history-item">–î–†: —Ç–æ—Ä—Ç –≤ –ø–æ–¥–∞—Ä–æ–∫ (–æ—Ç 1000 –±–∞–ª–ª–æ–≤)</div>
            </div>
        </div>

        <div class="card">
            <h3>üìä –ò—Å—Ç–æ—Ä–∏—è</h3>
            <div class="history" id="historyList"></div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —á–µ–∫–∞ -->
    <div id="checkinModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); background: white; border-radius: 20px; padding: 30px; max-width: 90%;">
            <h3>üì∏ –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —á–µ–∫</h3>
            <input type="text" id="checkNumber" placeholder="–ù–æ–º–µ—Ä —á–µ–∫–∞ –∏–ª–∏ —Å—É–º–º–∞" style="width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 10px; margin: 15px 0;">
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" style="flex: 1;" onclick="processCheck()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                <button class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        
        const user = Telegram.WebApp.initDataUnsafe?.user || { first_name: '–ì–æ—Å—Ç—å', id: 12345 };
        const tg = Telegram.WebApp;

        // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö
        let userData = JSON.parse(localStorage.getItem(`loyalty_${user.id}`)) || {
            balance: 0,
            level: 1,
            nextLevel: 500,
            history: [],
            userId: user.id
        };

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        function render() {
            document.getElementById('userName').textContent = `–ü—Ä–∏–≤–µ—Ç, ${user.first_name}!`;
            document.getElementById('balance').textContent = `${userData.balance} –±–∞–ª–ª–æ–≤`;
            document.getElementById('nextLevel').textContent = userData.nextLevel;
            document.getElementById('levelProgress').style.width = 
                `${Math.min(100, (500 - userData.nextLevel) / 5)}%`;
            document.getElementById('qrCode').textContent = `ID: ${user.id}
–°—Ç–∞—Ç—É—Å: ${getStatus()}`;
            
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = userData.history.slice(-5).map(h => 
                `<div class="history-item">${h}</div>`
            ).join('');
            
            localStorage.setItem(`loyalty_${user.id}`, JSON.stringify(userData));
            tg.MainButton.setText('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É').show().onClick(sendToBot);
        }

        function getStatus() {
            if (userData.balance >= 2000) return 'ü•á VIP';
            if (userData.balance >= 500) return 'ü•à –°–µ—Ä–µ–±—Ä–æ';
            return 'ü•â –ë—Ä–æ–Ω–∑–∞';
        }

        // –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤
        function showCheckin() {
            document.getElementById('checkinModal').style.display = 'block';
            tg.HapticFeedback.impactOccurred('medium');
        }

        function processCheck() {
            const checkInput = document.getElementById('checkNumber').value;
            const amount = parseFloat(checkInput) || 1000;
            const bonus = Math.floor(amount * 0.08); // 8% –±–æ–Ω—É—Å–æ–≤
            
            userData.balance += bonus;
            userData.nextLevel = Math.max(0, userData.nextLevel - bonus);
            
            if (userData.nextLevel <= 0) {
                userData.level++;
                userData.nextLevel = 500;
                tg.showAlert('üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å!');
            }
            
            userData.history.unshift(`+${bonus} –±–∞–ª–ª–æ–≤ (—á–µ–∫ ${amount}‚ÇΩ)`);
            render();
            closeModal();
            tg.HapticFeedback.notificationOccurred('success');
        }

        // –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤
        function spendBonus() {
            if (userData.balance < 50) {
                tg.showAlert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤ (–º–∏–Ω–∏–º—É–º 50)');
                return;
            }
            const spend = Math.floor(userData.balance / 10) * 10;
            userData.balance -= spend;
            userData.history.unshift(`-${spend} –±–∞–ª–ª–æ–≤ (—Å–∫–∏–¥–∫–∞ ${spend/10}‚ÇΩ)`);
            render();
            tg.HapticFeedback.notificationOccurred('error');
        }

        function closeModal() {
            document.getElementById('checkinModal').style.display = 'none';
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç—É
        function sendToBot() {
            const data = {
                userId: user.id,
                balance: userData.balance,
                level: userData.level,
                action: 'update_balance'
            };
            tg.sendData(JSON.stringify(data));
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        render();
        
        // –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        tg.MainButton.setParams({ color: '#4CAF50', text_color: '#fff' });
    </script>
</body>
</html>